<!--

​    Licensed to the Apache Software Foundation (ASF) under one
​    or more contributor license agreements.  See the NOTICE file
​    distributed with this work for additional information
​    regarding copyright ownership.  The ASF licenses this file
​    to you under the Apache License, Version 2.0 (the
​    "License"); you may not use this file except in compliance
​    with the License.  You may obtain a copy of the License at
​    
​        http://www.apache.org/licenses/LICENSE-2.0
​    
​    Unless required by applicable law or agreed to in writing,
​    software distributed under the License is distributed on an
​    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
​    KIND, either express or implied.  See the License for the
​    specific language governing permissions and limitations
​    under the License.

-->

# 时间序列预测
## Decompose

### 函数简介

本函数使用传统加法或乘法模型将输入时间序列分解为趋势项、季节项、残差项之和。

**函数名：** Decompose

**输入序列：** 仅支持单个输入序列，类型为 INT32 / INT64 / FLOAT / DOUBLE。

**参数：**
+ `period`: 输入序列的周期长度，应当为大于 1 的整数。按数据点的个数计。
+ `method`: 分解使用的模型。 可以取 "additive" 或 "multiplicative". 默认值为 "additive".
+ `output`: 指示输出序列。可以取 "trend", "seasonal" 或 "residual". 默认值为 "trend".

**输出序列：** 输出单个序列，类型为 DOUBLE。

**提示：** 函数忽略输入序列中的 NaN. 认为数据点是等间隔的。用户可以先进行重采样再进行分解。

### 使用示例

#### 使用加法模型分解
输入序列：

```
+-----------------------------+---------------+
|                         Time|root.test.d1.s1|
+-----------------------------+---------------+
|1970-01-01T08:00:00.000+08:00|         315.71|
|1970-01-01T08:00:00.001+08:00|         317.45|
|1970-01-01T08:00:00.002+08:00|          317.5|
|1970-01-01T08:00:00.003+08:00|          317.1|
|1970-01-01T08:00:00.004+08:00|         315.86|
|1970-01-01T08:00:00.005+08:00|         314.93|
|1970-01-01T08:00:00.006+08:00|          313.2|
...
Total line number = 708
```

用于查询的 SQL 语句：

```sql
select decompose(s1, 'period' = '12', 'method' = 'additive', 'output' = 'trend') from root.test.d1
```

输出序列：

```
+-----------------------------+--------------------------------------------------------------------------------+
|                         Time|decompose(root.test.d1.s1, "period"="12", "method"="additive", "output"="trend")|
+-----------------------------+--------------------------------------------------------------------------------+
|1970-01-01T08:00:00.006+08:00|                                                              315.40916666666664|
|1970-01-01T08:00:00.007+08:00|                                                              315.46208333333334|
|1970-01-01T08:00:00.008+08:00|                                                                       315.50625|
|1970-01-01T08:00:00.009+08:00|                                                               315.5829166666667|
|1970-01-01T08:00:00.010+08:00|                                                              315.65500000000003|
|1970-01-01T08:00:00.011+08:00|                                                               315.6779166666667|
|1970-01-01T08:00:00.012+08:00|                                                              315.69916666666666|
...
Total line number = 696
```
用于查询的 SQL 语句：

```sql
select decompose(s1, 'period' = '12', 'method' = 'additive', 'output' = 'residual') from root.test.d1
```

输出序列：

```
+-----------------------------+-----------------------------------------------------------------------------------+
|                         Time|decompose(root.test.d1.s1, "period"="12", "method"="additive", "output"="residual")|
+-----------------------------+-----------------------------------------------------------------------------------+
|1970-01-01T08:00:00.006+08:00|                                                                 0.9237356321838588|
|1970-01-01T08:00:00.007+08:00|                                                                0.43947557471259424|
|1970-01-01T08:00:00.008+08:00|                                                               -0.11025862068976355|
|1970-01-01T08:00:00.009+08:00|                                                              -0.028714080459828817|
|1970-01-01T08:00:00.010+08:00|                                                               -0.07654454022997274|
|1970-01-01T08:00:00.011+08:00|                                                                0.01531609195390815|
|1970-01-01T08:00:00.012+08:00|                                                                -0.4370043103448982|
...
Total line number = 696
```
#### 使用乘法模型分解

输入序列：

```
+-----------------------------+---------------+
|                         Time|root.test.d1.s1|
+-----------------------------+---------------+
|1970-01-01T08:00:00.000+08:00|         315.71|
|1970-01-01T08:00:00.001+08:00|         317.45|
|1970-01-01T08:00:00.002+08:00|          317.5|
|1970-01-01T08:00:00.003+08:00|          317.1|
|1970-01-01T08:00:00.004+08:00|         315.86|
|1970-01-01T08:00:00.005+08:00|         314.93|
|1970-01-01T08:00:00.006+08:00|          313.2|
...
Total line number = 708
```

用于查询的 SQL 语句：

```sql
select decompose(s1, 'period' = '12', 'method' = 'multiplicative', 'output' = 'trend') from root.test.d1
```

输出序列：

```
+-----------------------------+--------------------------------------------------------------------------------------+
|                         Time|decompose(root.test.d1.s1, "period"="12", "method"="multiplicative", "output"="trend")|
+-----------------------------+--------------------------------------------------------------------------------------+
|1970-01-01T08:00:00.006+08:00|                                                                    315.40916666666664|
|1970-01-01T08:00:00.007+08:00|                                                                    315.46208333333334|
|1970-01-01T08:00:00.008+08:00|                                                                             315.50625|
|1970-01-01T08:00:00.009+08:00|                                                                     315.5829166666667|
|1970-01-01T08:00:00.010+08:00|                                                                    315.65500000000003|
|1970-01-01T08:00:00.011+08:00|                                                                     315.6779166666667|
|1970-01-01T08:00:00.012+08:00|                                                                    315.69916666666666|
...
Total line number = 696
```
用于查询的 SQL 语句：

```sql
select decompose(s1, 'period' = '12', 'method' = 'multiplicative', 'output' = 'residual') from root.test.d1
```

输出序列：

```
+-----------------------------+-----------------------------------------------------------------------------------------+
|                         Time|decompose(root.test.d1.s1, "period"="12", "method"="multiplicative", "output"="residual")|
+-----------------------------+-----------------------------------------------------------------------------------------+
|1970-01-01T08:00:00.006+08:00|                                                                        1.001927194431198|
|1970-01-01T08:00:00.007+08:00|                                                                       1.0003686308901425|
|1970-01-01T08:00:00.008+08:00|                                                                         0.99899519389507|
|1970-01-01T08:00:00.009+08:00|                                                                       0.9996499295945565|
|1970-01-01T08:00:00.010+08:00|                                                                       0.9997951326019452|
|1970-01-01T08:00:00.011+08:00|                                                                       1.0002873633298288|
|1970-01-01T08:00:00.012+08:00|                                                                       0.9990986638746625|
...
Total line number = 696
```



## STL

### 函数简介

本函数使用STL方法将输入时间序列分解为趋势项、季节项、残差项之和。

**函数名：** STL

**输入序列：** 仅支持单个输入序列，类型为 INT32 / INT64 / FLOAT / DOUBLE。

**参数：**

+ `period`: 输入序列的周期长度，应当为大于 1 的整数。按数据点的个数计。
+ `swindow`: 季节项提取时的 LOESS 窗口长度（含滞后项），应当为奇数且大于等于 7. 缺省时使用周期回归。
+ `sdegree`: 季节项提取时局部拟合的多项式次数。应当为 0 或 1. 默认为 0.
+ `sjump`: 大于等于 1 的整数，用于提升季节平滑的计算速度。每隔`sjump`个点进行线性插值。默认值为 `ceil(swindow/10)`.
+ `twindow`: 趋势项提取时的 LOESS 窗口长度（含滞后项），应当为奇数。默认值为 `nextodd(ceil((1.5*period) / (1-(1.5/swindow))))`.
+ `tdegree`: 趋势项提取时局部拟合的多项式次数。应当为 0 或 1. 默认为 1.
+ `tjump`:  大于等于 1 的整数，用于提升趋势平滑的计算速度。每隔`tjump`个点进行线性插值。默认值为`ceil(twindow/10)`.
+ `lwindow`: 对每个子序列进行低通滤波时的 LOESS 窗口长度（含滞后项）。默认为不小于`period`的最小奇数.
+ `ldegree`: 子序列低通滤波时局部拟合的多项式次数。应当为 0 或 1. 默认等于`tdegree`.
+ `ljump`: 大于等于 1 的整数，用于提升低通滤波平滑的计算速度。每隔`ljump`个点进行线性插值。默认值为 `ceil(lwindow/10)`.
+ `robust`: 布尔值，指示是否在 LOESS 过程中使用鲁棒拟合。默认为 false.
+ `output`: 指示输出序列。可以取 "trend", "seasonal" 或 "residual". 默认值为 "trend".

**输出序列：** 输出单个序列，类型为 DOUBLE。

**提示：** 函数忽略输入序列中的 NaN. 认为数据点是等间隔的。用户可以先进行重采样再进行分解。

### 使用示例

#### 指定周期长度分解

输入序列：

```
+-----------------------------+---------------+
|                         Time|root.test.d1.s1|
+-----------------------------+---------------+
|1970-01-01T08:00:00.000+08:00|         315.71|
|1970-01-01T08:00:00.001+08:00|         317.45|
|1970-01-01T08:00:00.002+08:00|          317.5|
|1970-01-01T08:00:00.003+08:00|          317.1|
|1970-01-01T08:00:00.004+08:00|         315.86|
|1970-01-01T08:00:00.005+08:00|         314.93|
|1970-01-01T08:00:00.006+08:00|          313.2|
...
Total line number = 708
```

用于查询的 SQL 语句：

```sql
select stl(s1, 'period' = '12', 'swindow' = '35', 'output' = 'trend') from root.test.d1
```

输出序列：

```
+-----------------------------+---------------------------------------------------------------------+
|                         Time|stl(root.test.d1.s1, "period"="12", "swindow"="35", "output"="trend")|
+-----------------------------+---------------------------------------------------------------------+
|1970-01-01T08:00:00.000+08:00|                                                    314.8471139496001|
|1970-01-01T08:00:00.001+08:00|                                                   314.94118165200905|
|1970-01-01T08:00:00.002+08:00|                                                   315.03524935441806|
|1970-01-01T08:00:00.003+08:00|                                                    315.1204665476064|
|1970-01-01T08:00:00.004+08:00|                                                   315.20568374079465|
|1970-01-01T08:00:00.005+08:00|                                                    315.2847651687474|
|1970-01-01T08:00:00.006+08:00|                                                   315.36384659670017|
...
Total line number = 708
```

用于查询的 SQL 语句：

```sql
select stl(s1, 'period' = '12', 'swindow' = '35', 'output' = 'residual') from root.test.d1
```

输出序列：

```
+-----------------------------+------------------------------------------------------------------------+
|                         Time|stl(root.test.d1.s1, "period"="12", "swindow"="35", "output"="residual")|
+-----------------------------+------------------------------------------------------------------------+
|1970-01-01T08:00:00.000+08:00|                                                    -0.37531049196786626|
|1970-01-01T08:00:00.001+08:00|                                                     0.14743669754562916|
|1970-01-01T08:00:00.002+08:00|                                                    -0.35080487369970115|
|1970-01-01T08:00:00.003+08:00|                                                     -0.2518283153173684|
|1970-01-01T08:00:00.004+08:00|                                                    -0.19777243845459225|
|1970-01-01T08:00:00.005+08:00|                                                       0.799142917146412|
|1970-01-01T08:00:00.006+08:00|                                                      0.6671653485419711|
...
Total line number = 708
```



## AR

### 函数简介

本函数使用自回归模型（Autoregressive model）拟合输入时间序列，计算自回归系数并预测后续数据。

**函数名：** AR

**输入序列：** 仅支持单个输入序列，类型为 INT32 / INT64 / FLOAT / DOUBLE。

**参数：**

+ p: 模型阶数，应当为正整数。
+ steps：预测步数。默认为1。
+ output: 指示输出序列。可以取 “coefficient”, “sequence”, “forecast” 或 “residual”。默认值为 “ coefficient ”。

**输出序列：** 输出单个序列，类型为 DOUBLE。输出序列可以为：

- 自回归系数
- 拟合序列
- 预测结果
- 残差

**提示：** 函数忽略输入序列中的 NaN。

### 使用示例

输入序列：

```
+-----------------------------+---------------+
|                         Time|root.test.d1.s1|
+-----------------------------+---------------+
|1970-01-01T08:00:00.000+08:00|       0.615367|
|1970-01-01T08:00:00.001+08:00|       1.300980|
|1970-01-01T08:00:00.002+08:00|      -0.218203|
|1970-01-01T08:00:00.003+08:00|      -0.976345|
|1970-01-01T08:00:00.004+08:00|      -0.531409|
|1970-01-01T08:00:00.005+08:00|       0.044977|
|1970-01-01T08:00:00.006+08:00|       1.048613|
...
Total line number = 300
```

#### 输出自回归系数

用于查询的 SQL 语句：

```sql
select ar(s1, 'p' = '5', 'output' = 'coefficient') from root.test.d1
```

输出序列：

```
+-----------------------------+-------------------------------------------+
|                         Time|ar(s1, 'p' = '5', 'output' = 'coefficient')|
+-----------------------------+-------------------------------------------+
|1970-01-01T08:00:00.000+08:00|                        0.25615431956708135|
|1970-01-01T08:00:00.001+08:00|                       -0.12861216153365415|
|1970-01-01T08:00:00.002+08:00|                        -0.3625302723212474|
|1970-01-01T08:00:00.003+08:00|                       -0.25106238043665424|
|1970-01-01T08:00:00.004+08:00|                        0.22001738996752368|
+-----------------------------+-------------------------------------------+
```

#### 输出拟合序列

用于查询的 SQL 语句：

```sql
select ar(s1, 'p' = '5', 'output' = 'sequence') from root.test.d1
```

输出序列：

```
+-----------------------------+----------------------------------------+
|                         Time|ar(s1, 'p' = '5', 'output' = 'sequence')|
+-----------------------------+----------------------------------------+
|1970-01-01T08:00:00.000+08:00|                                0.615367|
|1970-01-01T08:00:00.001+08:00|                                 1.30098|
|1970-01-01T08:00:00.002+08:00|                                0.759738|
|1970-01-01T08:00:00.003+08:00|                               -0.218203|
|1970-01-01T08:00:00.004+08:00|                               -0.976345|
|1970-01-01T08:00:00.005+08:00|                     -0.6886951481757273|
|1970-01-01T08:00:00.006+08:00|                     0.16404891626883172|
|1970-01-01T08:00:00.007+08:00|                      0.6557594681266603|
|1970-01-01T08:00:00.008+08:00|                      0.6525890550832002|
...
Total line number = 300
```

#### 输出预测结果

用于查询的 SQL 语句：

```sql
select ar(s1, 'p' = '5', 'output' = 'forecast', 'steps' = '5') from root.test.d1
```

输出序列：

```
+-----------------------------+-------------------------------------------------------+
|                         Time|ar(s1, 'p' = '5', 'output' = 'sequence', 'steps' = '5')|
+-----------------------------+-------------------------------------------------------+
|1970-01-01T08:00:00.000+08:00|                                   -0.30958964586848625|
|1970-01-01T08:00:00.001+08:00|                                     0.6191163629660078|
|1970-01-01T08:00:00.002+08:00|                                     0.9261617123785985|
|1970-01-01T08:00:00.003+08:00|                                    0.25702299037943743|
|1970-01-01T08:00:00.004+08:00|                                    -0.4136313859656312|
+-----------------------------+-------------------------------------------------------+
```

#### 输出残差

用于查询的 SQL 语句：

```sql
select ar(s1, 'p' = '5', 'output' = 'residual') from root.test.d1
```

输出序列：

```
+-----------------------------+----------------------------------------+
|                         Time|ar(s1, 'p' = '5', 'output' = 'residual')|
+-----------------------------+----------------------------------------+
|1970-01-01T08:00:00.000+08:00|                                     0.0|
|1970-01-01T08:00:00.001+08:00|                                     0.0|
|1970-01-01T08:00:00.002+08:00|                                     0.0|
|1970-01-01T08:00:00.003+08:00|                                     0.0|
|1970-01-01T08:00:00.004+08:00|                                     0.0|
|1970-01-01T08:00:00.005+08:00|                     0.15728614817572728|
|1970-01-01T08:00:00.006+08:00|                    -0.11907191626883172|
|1970-01-01T08:00:00.007+08:00|                      0.3928535318733397|
|1970-01-01T08:00:00.008+08:00|                     0.23926594491679976|
...
Total line number = 300
```

